/* ============================================================================
    PROJECT: Dynamic Open World Engine (DOWE) “The Mini Giant”
    VERSION: 1.1 (Master Build - Safety Merged)
    DATE: February 11, 2026
    PLATFORM: Neverwinter Nights: Enhanced Edition (NWN:EE)
    Script Name: enc_spawn
    PILLARS: 
        1. Environmental Reactivity (Surface Checks)
        2. Phase-Staggered Performance Optimization 
        3. Total Resource Management (Safe Spawning)
    
    DESCRIPTION:
    Determines rarity based on rolls, checks surface material, validates
    that the spawn isn't in a wall, and enforces the "One-Encounter-Only" rule.
   ============================================================================
*/

void main()
{
    // PHASE 1: DATA & CAP VALIDATION
    object oArea = OBJECT_SELF;
    object oPC = GetLocalObject(oArea, "MG_SW_TARGET");
    
    // Safety: Prevent "Gank-Loop" (One active encounter per player name).
    if (GetLocalInt(oPC, "MG_ENC_ACTIVE") == TRUE) return;

    // PHASE 2: ENVIRONMENTAL & RARITY (From your version)
    int nSurface = GetSurfaceMaterial(GetLocation(oPC)); 
    int nRoll = Random(100) + 1;
    int nTier = 1; // Default Common
    if (nRoll > 95) nTier = 3;      // Rare
    else if (nRoll > 70) nTier = 2; // Uncommon

    // PHASE 3: DISTANCE & WALL CHECK (Safety Patch)
    int nDistRoll = Random(100) + 1;
    float fDist = 15.0; 
    if (nDistRoll <= 15) fDist = 5.0;
    else if (nDistRoll > 85) fDist = 30.0;

    vector vPos = GetPosition(oPC);
    float fAngle = IntToFloat(Random(360));
    vector vTarget = vPos + AngleToVector(fAngle) * fDist;

    // Triple Check: Ensure spawn isn't in a wall or void.
    if (LineOfSightVector(vPos, vTarget) == FALSE)
    {
        // Emergency adjustment: pull spawn closer to player if wall detected.
        vTarget = vPos + AngleToVector(fAngle) * 2.0;
    }
    location lFinal = Location(oArea, vTarget, 0.0);

    // PHASE 4: STAGGERED EXECUTION
    int nNum = Random(6) + 1;
    int i;
    for (i = 1; i <= nNum; i++)
    {
        float fStag = i * 0.25;
        // ResRef selection logic based on nTier and nSurface goes here.
        string sRes = "nw_wolf001"; 

        DelayCommand(fStag, SetLocalString(oArea, "MG_SPAWN_RES", sRes));
        DelayCommand(fStag, SetLocalLocation(oArea, "MG_SPAWN_LOC", lFinal));
        DelayCommand(fStag + 0.01, ExecuteScript("enc_create_helper", oArea));
    }

    // Mark player active so they don't get double-spawned next pulse.
    SetLocalInt(oPC, "MG_ENC_ACTIVE", TRUE);
}
