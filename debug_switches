/* ============================================================================
    PROJECT: Dynamic Open World Engine (DOWE)
    VERSION: 2.0 (Master Build)
    PLATFORM: Neverwinter Nights: Enhanced Edition (NWN:EE)
    DATE: February 11, 2026
    Script Name: debug_switches
    
    PILLARS:
    1. Independent Mini-Servers Architecture
    2. Phase-Staggered Performance Optimization
    3. Total Resource Management (Zero-Waste)
    
    DESCRIPTION:
    A standalone MUD-style command handler. This script is called by the
    MUD engine when a player uses the "/*" command prefix. It manages
    global system toggles without being tethered to a specific debug script.
   ============================================================================
*/

// --- VIP LIST AUTHENTICATION ---
// Logic: Validates user against the VIP Database before allowing engine overrides.
int GetIsVIP(object oPC) {
    return GetLocalInt(oPC, "VIP_USER");
}

// --- STAGGERED FEEDBACK ---
void StaggeredNotify(object oPC, string sMsg, float fDelay) {
    DelayCommand(fDelay, SendMessageToPC(oPC, sMsg));
}

void main() {
    // PHASE 1: Data Acquisition
    // In MUD systems, the speaker is usually the OBJECT_SELF or retrieved via GetPCChatSpeaker.
    object oPC = GetPCChatSpeaker();
    string sMessage = GetStringLowerCase(GetPCChatMessage());
    object oMod = GetModule();

    // PHASE 2: VIP Security Filter
    // Standalone security layer ensuring only VIPs/DMs manipulate the "Mini Giant."
    if (!GetIsVIP(oPC) && !GetIsDM(oPC)) {
        StaggeredNotify(oPC, "DOWE MUD: Permission Denied. VIP authentication failed.", 0.1);
        return;
    }

    // PHASE 3: Command Parsing (MUD Style)
    // We remove the "/*" and split the remaining string.
    string sClean = GetStringRight(sMessage, GetStringLength(sMessage) - 2);
    int nSpace = FindSubString(sClean, " ");
    
    string sSystem, sState;
    if (nSpace == -1) {
        sSystem = sClean;
    } else {
        sSystem = GetSubString(sClean, 0, nSpace);
        sState = GetSubString(sClean, nSpace + 1, GetStringLength(sClean) - nSpace);
    }

    // PHASE 4: Action Branching (Staggered for Performance)
    if (sSystem == "status") {
        int nEnc = GetLocalInt(oMod, "DOWE_SYSTEM_ENCOUNTER_ACTIVE");
        int nCrft = GetLocalInt(oMod, "DOWE_SYSTEM_CRAFT_ACTIVE");
        int nDbug = GetLocalInt(oMod, "DOWE_DEBUG_ACTIVE");
        
        StaggeredNotify(oPC, "--- DOWE ENGINE STATUS ---", 0.1);
        StaggeredNotify(oPC, "ENCOUNTERS: " + (nEnc ? "ON" : "OFF"), 0.2);
        StaggeredNotify(oPC, "CRAFTING:   " + (nCrft ? "ON" : "OFF"), 0.3);
        StaggeredNotify(oPC, "DEBUG LOGS: " + (nDbug ? "ON" : "OFF"), 0.4);
    }
    else if (sSystem == "encounter") {
        int bNew = (sState == "on");
        SetLocalInt(oMod, "DOWE_SYSTEM_ENCOUNTER_ACTIVE", bNew);
        StaggeredNotify(oPC, "DOWE: Encounter Engine toggled " + sState, 0.1);
    }
    else if (sSystem == "craft") {
        int bNew = (sState == "on");
        SetLocalInt(oMod, "DOWE_SYSTEM_CRAFT_ACTIVE", bNew);
        StaggeredNotify(oPC, "DOWE: Crafting Engine toggled " + sState, 0.1);
    }
    else if (sSystem == "debug") {
        int bNew = (sState == "on");
        SetLocalInt(oMod, "DOWE_DEBUG_ACTIVE", bNew);
        StaggeredNotify(oPC, "DOWE: Debug Master Switch toggled " + sState, 0.1);
    }
    else {
        StaggeredNotify(oPC, "DOWE: Unknown MUD Command. Use /*status, /*encounter, /*craft, or /*debug.", 0.1);
    }
}
