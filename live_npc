/* ============================================================================
    Project Name: Dynamic Open World Engine (DOWE) “The Mini Giant”
    VERSION: 1.0 (Master Build)
    DATE: February 11, 2026
    PLATFORM: Neverwinter Nights: Enhanced Edition (NWN:EE)
    Script Name: live_npc
    PILLARS: 
        1. Independent Mini-Servers Architecture 
        2. Phase-Staggered Performance Optimization 
        3. Total Resource Management (Zero-Waste)
    
    DESCRIPTION:
    Spawns "Pseudo-Player" NPCs via waypoints to test mini-server load.
    Waypoints: [NPC_NAME][SPEED] (e.g., Guard1). 1=Fast, 2=Normal.
    Uses a helper function to ensure 100% NWN:EE compiler compatibility.
   ============================================================================
*/

// --- HELPER FUNCTION ---
// Notes: Standard void function to satisfy the DelayCommand parameter requirements.
void DOWE_SpawnNPC(string sRes, location lLoc)
{
    CreateObject(OBJECT_TYPE_CREATURE, sRes, lLoc);
}

void main()
{
    // PHASE 1: INITIALIZATION
    object oArea = OBJECT_SELF;
    
    // Triple-Check: Toggle and Activation state.
    if (GetLocalInt(oArea, "MG_LIVE_NPC_ON") == FALSE) return;
    if (GetLocalInt(oArea, "MG_LIVE_NPC_ACTIVE") == TRUE) return;
    
    SetLocalInt(oArea, "MG_LIVE_NPC_ACTIVE", TRUE);

    // PHASE 2: SCANNING
    int nNth = 0;
    object oWP = GetObjectByTag("WP_LIVE_NPC", nNth);

    while (GetIsObjectValid(oWP))
    {
        string sWPName = GetName(oWP); 
        int nLen       = GetStringLength(sWPName);
        string sSpeed  = GetSubString(sWPName, nLen - 1, 1);
        string sResRef = GetSubString(sWPName, 0, nLen - 1);
        location lLoc  = GetLocation(oWP);

        // Determine Delay based on Speed Suffix
        float fDelay;
        if (sSpeed == "1") fDelay = 0.05;
        else fDelay = 2.0;

        // PHASE 3: STAGGERED SPAWNING
        // Notes: Calling the helper function ensures no 'Declaration Match' errors.
        DelayCommand(fDelay, DOWE_SpawnNPC(sResRef, lLoc));

        // PHASE 4: REGISTRY HANDOFF (Staggered)
        // Wait for the NPC to physically exist, then find and register it.
        float fRegDelay = fDelay + 1.2; 
        
        DelayCommand(fRegDelay, SetLocalObject(oArea, "MG_SW_TARGET", GetNearestObjectByTag(sResRef, oWP)));
        DelayCommand(fRegDelay + 0.05, SetLocalInt(oArea, "MG_SW_EVENT", 100)); // 100 = Registry
        
        // Debug and Execute Switchboard
        DelayCommand(fRegDelay + 0.1, SetLocalString(oArea, "MG_DEBUG_MSG", "LIVE_NPC: Spawning " + sResRef));
        DelayCommand(fRegDelay + 0.15, ExecuteScript("area_switchboard", oArea));

        nNth++;
        oWP = GetObjectByTag("WP_LIVE_NPC", nNth);
    }
}
